---
title: "Journal (reproducible report)"
author: "Aadi Nath Mishra"
date: "Dec 3 2020"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

# Challenge 1 - Sales Analysis

## Sales Analysis by State
```{r plot, fig.width=10, fig.height=10}
# 1.0 Load libraries ----
library(tidyverse)
library(readxl)
library(lubridate)
library(writexl)

# 2.0 Import data ----
bikes_tbl <- read_excel(path = "DS_101/00_data/01_bike_sales/01_raw_data/bikes.xlsx")
orderlines_tbl <- read_excel("DS_101/00_data/01_bike_sales/01_raw_data/orderlines.xlsx")
bikeshops_tbl  <- read_excel("DS_101/00_data/01_bike_sales/01_raw_data/bikeshops.xlsx")

# 3.0 Examining Data ----
orderlines_tbl

# 4.0 Joining Data ----
bike_orderlines_joined_tbl <- orderlines_tbl %>%
  left_join(bikes_tbl, by = c("product.id" = "bike.id")) %>%
  left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))

# 5.0 Wrangling Data ----

bike_orderlines_wrangled_tbl <- bike_orderlines_joined_tbl %>%
  separate(col    = location,
           into   = c("city", "state"),
           sep    = ", ") %>%
  
  mutate(total.price = price * quantity) %>%
  select(-...1, -gender) %>%
  select(-ends_with(".id")) %>%
  bind_cols(bike_orderlines_joined_tbl %>% select(order.id)) %>% 
  
  select(order.id, contains("order"), contains("model"), contains("state"),
         contains("city"), price, quantity, total.price,
         everything()) %>%
  
  rename(bikeshop = name) %>%
  set_names(names(.) %>% str_replace_all("\\.", "_"))

# 6.0 Business Insights ----
# 6.1 Sales by Year ----
# Manipulate the data and store result
sales_by_loc_tbl <- bike_orderlines_wrangled_tbl %>%
  
  # Select columns
  select(contains("state"), total_price) %>%
  
  # Grouping by year and summarizing sales
  group_by(state) %>% 
  summarize(sales = sum(total_price)) %>%
  arrange(desc(sales)) %>%
  # Optional: Add a column that turns the numbers into a currency format 
  # (makes it in the plot optically more appealing)
  # mutate(sales_text = scales::dollar(sales)) <- Works for dollar values
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))

sales_by_loc_tbl

sales_by_loc_tbl %>%
  
  # Step 2 - Visualize
  # Setup canvas with the columns state (x-axis) and sales (y-axis)
  # States are reordered in decreasing sales for a better visual (e.g. similar to Pareto chart)
  ggplot(aes(x = reorder(state,-sales), y = sales)) +
  # Rotate the x-axis labels
  theme(axis.title.x = element_text(), axis.text.x = element_text(angle = 45, hjust = 1)) +
  
  # Geometries
  geom_col(fill = "#2D303E") + # Use geom_col for a bar plot and fill with color
  # Adding labels to the bars along with formatting for better presentation
  geom_text(aes(label = sales_text), position = position_dodge(width = 0.9), 
            hjust = -0.1, size = 2.5, show.legend = FALSE, angle = 90) +
  
  # Formatting and re-scaling the y-axis
  # Again, we have to adjust it for euro values
  scale_y_continuous(expand = c(0,0), limits = c(0,25000000),
                     labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  
  # Final touches to the plot to ensure titles/subtitles are present
  labs(title    = "Revenue by State",
       subtitle = "Ordered from most to least total revenue",
       x = "State", # Changes the x-axis name
       y = "Revenue")
```



## Sales Analysis by State and Year 
```{r plot2, fig.width=10, fig.height=10}
# 6.2 Sales by Year and location ----
# Manipulate the data and store result
sales_by_loc_year_tbl <- bike_orderlines_wrangled_tbl %>%
  
  # Select columns
  select(order_date, contains("state"), total_price) %>%
  
  # Add year column
  # Note the year() function runs if "lubridate" package was run via library() function
  mutate(year = year(order_date)) %>%
  
  # Grouping by state and year and summarizing sales
  group_by(state, year) %>% 
  summarize(sales = sum(total_price)) %>%
  arrange(year) %>% 
  ungroup() %>%
  
  # Format $ Text
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))

sales_by_loc_year_tbl

sales_by_loc_year_tbl %>%
  # Setup canvas with the columns year (x-axis), sales (y-axis) and state (fill)
  ggplot(aes(x = year, y = sales, fill = state)) +
  # Rotate the x-axis labels
  theme(axis.title.x = element_text(), axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="top") +
  
  # Geometries
  geom_col() + # Use geom_col for a bar plot
  
  # Facet
  facet_wrap(~ state, nrow = 2) +
  
  # Adding labels to the bars along with formatting for better presentation
  geom_text(aes(label = sales_text), position = position_dodge(width = 0.9), 
            hjust = -0.1, size = 2.5, show.legend = FALSE, angle=90) +
  
  # Formatting and re-scaling the y-axis
  # Again, we have to adjust it for euro values
  scale_y_continuous(expand = c(0,0), limits = c(0,7500000),
                     labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  
  # Final touches to the plot to ensure titles/subtitles are present
  labs(title = "Revenue by State and Year",
       x = "Year",
       y = "Revenue",
       # Changes the legend name
       fill = "State") 
```

Last compiled: `r Sys.Date()`

# Challenge 2 - Data Acquisition

```{r}
# Import Libraries
library(fs)
library(tidyverse)
library(RSQLite)
library(httr)
library(glue)
library(jsonlite) 
library(stringr)
library(rvest)
library(purrr)


########################################################################################
itunes_search_api <- function(path, query) {
  url <- modify_url(url = "https://itunes.apple.com/", 
                    path = glue("/{path}"), 
                    query = glue("{query}"))
  response <- GET(url)
  stop_for_status(response) # automatically throws an error if a request did not succeed
}
response <- itunes_search_api("search", paste("term=dire+straits","limit=25",sep="&"))

# Convert JSON as text into a nested list object and convert to tibble
response_tbl <- fromJSON(content(response, as = "text")) %>%
  map_if(is.data.frame, list) %>%
  as_tibble() %>%
  unnest(cols = c(results))


response_tbl

#######
#Web Scraping 
url_home <- "https://www.radon-bikes.de/"
html_home <- read_html(url_home)
radonbike_category_tbl <- html_home%>% 
  html_nodes("div.megamenu__item > a") %>%
  html_attr('href')%>%
  discard(.p =~ str_detect(.x,"/wear/*"))%>%
  enframe(name = "position", value = "Category_Path")%>%
  separate(col = Category_Path, into = c("garbage1","Model", "Variant", "garbage2"), sep = "/")%>%
  select(Model, Variant)
radonbike_category_tbl
#https://www.radon-bikes.de/mountainbike/hardtail/

mountain_bike_hardtail_url <- str_c(url_home, radonbike_category_tbl$Model[1],"/",radonbike_category_tbl$Variant[1])

html_home <- read_html(mountain_bike_hardtail_url)
radonbike_hardtail_prices_tbl <- html_home%>%
  html_nodes("div.button-label > span")%>%
  html_text(trim = TRUE)%>% 
  strsplit(split = "\n") %>%
  unlist() %>%
  .[. != ""]%>%
  parse_number()%>%
  enframe(name = "position", value = "Hardtail_Prices")%>%
  select("Hardtail_Prices")
radonbike_hardtail_prices_tbl

mountain_bike_fullsuspension_url <- str_c(url_home, radonbike_category_tbl$Model[1],"/",radonbike_category_tbl$Variant[2])

html_home <- read_html(mountain_bike_fullsuspension_url)
radonbike_fullsuspension_prices_tbl <- html_home%>%
  html_nodes("div.button-label > span")%>%
  html_text(trim = TRUE)%>% 
  strsplit(split = "\n") %>%
  unlist() %>%
  .[. != ""]%>%
  parse_number()%>%
  enframe(name = "position", value = "Fullsuspension_Prices")%>%
  select("Fullsuspension_Prices")
radonbike_fullsuspension_prices_tbl

```

When you knit this R Markdown document, you will see that the histogram is printed to the page, along with the R code. This document can be set up to hide the R code in the webpage, just delete the comment (hashtag) from the cold folding option in the yaml header up top. For purposes of letting yourself see the code, and me see the code, best to keep it the way that it is. You'll learn that all of these things and more can be customized in each R code block.